{% extends "base.html" %}

{% block title %}Trade Lab - Crypto Trading Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <button id="newCellBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Trade Cell
            </button>
        </div>
    </div>
    
    <div class="grid-stack">
        <!-- Trade cells will be dynamically added here -->
    </div>
</div>

<!-- Trade Cell Template -->
<template id="tradeCellTemplate">
    <div class="grid-stack-item" gs-w="4" gs-h="4">
        <div class="grid-stack-item-content">
            <div class="card bg-dark">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Trade Cell</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary cell-settings">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger cell-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas class="trade-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Settings Modal -->
<div class="modal fade" id="cellSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Cell Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cellSettingsForm">
                    <div class="mb-3">
                        <label class="form-label">Trading Pair</label>
                        <select class="form-select" name="tradingPair">
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="BNBUSDT">BNB/USDT</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Strategy</label>
                        <select class="form-select" name="strategy">
                            <option value="sma_crossover">SMA Crossover</option>
                            <option value="rsi">RSI Strategy</option>
                            <option value="macd">MACD Strategy</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Timeframe</label>
                        <select class="form-select" name="timeframe">
                            <option value="1m">1 minute</option>
                            <option value="5m">5 minutes</option>
                            <option value="15m">15 minutes</option>
                            <option value="1h">1 hour</option>
                            <option value="4h">4 hours</option>
                            <option value="1d">1 day</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveSettings">Save changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://kit.fontawesome.com/your-font-awesome-kit.js"></script>
<script>
let grid = GridStack.init({
    column: 12,
    animate: true,
    cellHeight: 80,
    margin: 10,
    minRow: 1,
    float: true
});

let cellCounter = 0;

document.getElementById('newCellBtn').addEventListener('click', () => {
    const template = document.getElementById('tradeCellTemplate');
    const cell = template.content.cloneNode(true);
    
    // Set unique ID for the cell
    cellCounter++;
    const cellId = `trade-cell-${cellCounter}`;
    cell.querySelector('.grid-stack-item').setAttribute('data-cell-id', cellId);
    
    // Add cell to grid
    grid.addWidget(cell);
    
    // Initialize chart for the new cell
    initializeChart(cellId);
});

function initializeChart(cellId) {
    const cell = document.querySelector(`[data-cell-id="${cellId}"]`);
    const canvas = cell.querySelector('.trade-chart');
    const chart = new Chart(canvas, {
        type: 'candlestick',
        data: {
            datasets: [{
                label: 'BTCUSDT',
                data: [] // Will be populated with real data
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Store chart reference
    canvas.chart = chart;
}

// Handle cell settings
document.addEventListener('click', (e) => {
    if (e.target.closest('.cell-settings')) {
        const cell = e.target.closest('.grid-stack-item');
        const modal = new bootstrap.Modal(document.getElementById('cellSettingsModal'));
        modal.show();
        
        // Store current cell ID for settings
        document.getElementById('cellSettingsModal').setAttribute('data-target-cell', cell.getAttribute('data-cell-id'));
    }
});

// Handle cell close
document.addEventListener('click', (e) => {
    if (e.target.closest('.cell-close')) {
        const cell = e.target.closest('.grid-stack-item');
        grid.removeWidget(cell);
    }
});

// Save cell settings
document.getElementById('saveSettings').addEventListener('click', () => {
    const modal = document.getElementById('cellSettingsModal');
    const cellId = modal.getAttribute('data-target-cell');
    const form = document.getElementById('cellSettingsForm');
    const formData = new FormData(form);
    
    // Update cell with new settings
    updateCellData(cellId, Object.fromEntries(formData));
    
    bootstrap.Modal.getInstance(modal).hide();
});

function updateCellData(cellId, settings) {
    // Fetch new data based on settings and update chart
    fetch(`/api/market-data/${settings.tradingPair}/${settings.timeframe}`)
        .then(response => response.json())
        .then(data => {
            const cell = document.querySelector(`[data-cell-id="${cellId}"]`);
            const canvas = cell.querySelector('.trade-chart');
            canvas.chart.data.datasets[0].data = data;
            canvas.chart.update();
        });
}
</script>
{% endblock %}
