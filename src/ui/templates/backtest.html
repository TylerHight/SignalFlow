{% extends "base.html" %}

{% block title %}Backtesting - Crypto Trading Platform{% endblock %}

{% block content %}
<div class="container-fluid px-4">
<div class="grid-stack">
    <div class="grid-stack-item" gs-w="8" gs-h="6">
        <div class="grid-stack-item-content">
            <div class="card-header">
                <h5 class="card-title">Backtest Results</h5>
            </div>
            <div class="card-body">
                <canvas id="backtestChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-w="4" gs-h="6">
        <div class="grid-stack-item-content">
            <div class="card-header">
                <h5 class="card-title">Strategy Configuration</h5>
            </div>
            <div class="card-body">
                <form id="backtestForm">
                    <div class="mb-3">
                        <label for="symbol" class="form-label">Trading Pair</label>
                        <input type="text" class="form-control" id="symbol" value="BTCUSDT">
                    </div>
                    <div class="mb-3">
                        <label for="timeframe" class="form-label">Timeframe</label>
                        <select class="form-control" id="timeframe">
                            <option value="1m">1 minute</option>
                            <option value="5m">5 minutes</option>
                            <option value="15m">15 minutes</option>
                            <option value="1h">1 hour</option>
                            <option value="4h">4 hours</option>
                            <option value="1d">1 day</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Indicators</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="maIndicator">
                            <label class="form-check-label" for="maIndicator">Moving Average</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rsiIndicator">
                            <label class="form-check-label" for="rsiIndicator">RSI</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="macdIndicator">
                            <label class="form-check-label" for="macdIndicator">MACD</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Run Backtest</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="grid-stack-item" gs-w="4" gs-h="4">
        <div class="grid-stack-item-content">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">Performance Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="metric-box">
                                <h6>Total Return</h6>
                                <span id="totalReturn">0%</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <h6>Sharpe Ratio</h6>
                                <span id="sharpeRatio">0.00</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <h6>Max Drawdown</h6>
                                <span id="maxDrawdown">0%</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-box">
                                <h6>Win Rate</h6>
                                <span id="winRate">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load saved layout if it exists
    let savedLayout = localStorage.getItem('backtestLayout');
    let initialLayout = savedLayout ? JSON.parse(savedLayout) : null;

    // Initialize GridStack
    var grid = GridStack.init({
        column: 12,
        animate: false,
        cellHeight: 60,
        minRow: 1,
        float: true,
        resizable: {
            handles: 'e,se,s,sw,w'
        },
        draggable: {
            handle: '.card-header',
            scroll: true
        },
        margin: 10,
        cellWidth: 100,
        minWidth: 200,
        disableDrag: false,
        disableResize: false,
        staticGrid: false,
        removable: false,
        gap: 15
    });

    grid.on('change', function(event, items) {
        localStorage.setItem('gridLayout', JSON.stringify(grid.save()));
    });

    // Load saved layout if it exists
    if (initialLayout) {
        grid.removeAll();
        grid.load(initialLayout);
    }

    // Initialize chart
    const ctx = document.getElementById('backtestChart').getContext('2d');
    const backtestChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Price',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Handle form submission
    document.getElementById('backtestForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            symbol: document.getElementById('symbol').value,
            timeframe: document.getElementById('timeframe').value,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            sma: document.getElementById('maIndicator').checked,
            rsi: document.getElementById('rsiIndicator').checked,
            macd: document.getElementById('macdIndicator').checked
        };
        
        // Run backtest
        fetch('/api/backtest/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(results => {
            if (results.error) {
                alert('Error: ' + results.error);
                return;
            }
            
            // Update metrics
            document.getElementById('totalReturn').textContent = 
                (results.total_return * 100).toFixed(2) + '%';
            document.getElementById('sharpeRatio').textContent = 
                results.sharpe_ratio.toFixed(2);
            document.getElementById('maxDrawdown').textContent = 
                (results.max_drawdown * 100).toFixed(2) + '%';
            document.getElementById('winRate').textContent = 
                (results.win_rate * 100).toFixed(2) + '%';
            
            // Update chart
            updateBacktestChart(results.equity_curve);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error running backtest');
        });
    });
    
    function updateBacktestChart(equityCurve) {
        const labels = Array.from({length: equityCurve.length}, (_, i) => i + 1);
        
        backtestChart.data.labels = labels;
        backtestChart.data.datasets[0].data = equityCurve;
        backtestChart.update();
    }
</script>
{% endblock %}
